<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteo</title>
    <script src="/static/js/chart.js"></script>
</head>
<style>
    * {
        border: 0;
        margin: 0;
        color: #D1D4DC;
    }

    body {
        width: 100%;
        height: 100vh;
        background-color: #333333;
    }

    #container {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        height: 100%;
        gap: 10px;
    }

</style>
<body>
    <div id="container">
        <h2>Wind Speed (km/h)</h2>
        <div id="wind-speed-chart"></div>
        <h2>Wind Direction (degrees)</h2>
        <div id="wind-direction-chart"></div>
        <h2>Temperature (Â°C)</h2>
        <div id="temperature-chart"></div>
        <h2>Barometric pressure (hPa)</h2>
        <div id="bmp-chart"></div>
        <h2>Humidity (%)</h2>
        <div id="humidity-chart"></div>
        <h2>Battery (V)</h2>
        <div id="battery-chart"></div>
    </div>
</body>
<script>
    function createChartById(id) {
        return MyCharts.createChart(document.getElementById(id), {
            width: window.innerWidth*0.95, 
            height: 300,
            layout: {
                background: { color: '#121212' }, // chart background
                textColor: '#D1D4DC',             // axis + labels
            },
            grid: {
                vertLines: { color: '#2B2B43' },
                horzLines: { color: '#2B2B43' },
            },
            timeScale: {
                timeVisible: true,     // show HH:MM on the x-axis
                secondsVisible: false, // set to true if you want seconds
            },
        });
    }

    function fetchData() {
        fetch("/data", {
            method: "GET",
            headers: {
                'Content-Type': 'application/json'
            },
        })
        .then(response => response.json())
        .then(data => {
            const windSpeedData     = new Array();
            const windDirectionData = new Array();
            const temperatureData   = new Array();
            const humidityData      = new Array();
            const bmpData           = new Array();
            const batteryData       = new Array();
            Array.from(data).forEach(entry => {
                windSpeedData.push({time: entry[0], open: entry[1], close: entry[2], high: entry[3], low: entry[4]});
                windDirectionData.push({time: entry[0], value: (entry[9]-1)/8*360});
                temperatureData.push  ({time: entry[0], value: entry[5]});
                humidityData.push     ({time: entry[0], value: entry[6]});
                bmpData.push          ({time: entry[0], value: entry[7]});
                batteryData.push      ({time: entry[0], value: entry[8]});
            });
            windSpeedSeries.setData    (windSpeedData);
            windDirectionSeries.setData(windDirectionData);
            temperatureSeries.setData  (temperatureData);
            bmpSeries.setData          (bmpData);
            humiditySeries.setData     (humidityData);
            batterySeries.setData      (batteryData);
        });
    }

    const windSpeedChart     = createChartById('wind-speed-chart');
    const windDirectionChart = createChartById('wind-direction-chart');
    const temperatureChart   = createChartById('temperature-chart');
    const humidityChart      = createChartById('humidity-chart');
    const bmpChart           = createChartById('bmp-chart');
    const batteryChart       = createChartById('battery-chart');

    const windSpeedSeries     = windSpeedChart.addSeries     (MyCharts.CandlestickSeries);
    const windDirectionSeries = windDirectionChart.addSeries (MyCharts.LineSeries);
    const temperatureSeries   = temperatureChart.addSeries   (MyCharts.LineSeries);
    const humiditySeries      = humidityChart.addSeries      (MyCharts.LineSeries);
    const bmpSeries           = bmpChart.addSeries           (MyCharts.LineSeries);
    const batterySeries       = batteryChart.addSeries       (MyCharts.LineSeries);

    fetchData();

    setInterval(() => {
        fetchData();
    }, 5*60*1000);

    window.addEventListener('resize', () => {
        windSpeedChart.applyOptions     ({ width: window.innerWidth*0.95 });
        windDirectionChart.applyOptions ({ width: window.innerWidth*0.95 });
        temperatureChart.applyOptions   ({ width: window.innerWidth*0.95 });
        humidityChart.applyOptions      ({ width: window.innerWidth*0.95 });
        bmpChart.applyOptions      ({ width: window.innerWidth*0.95 });
        batteryChart.applyOptions       ({ width: window.innerWidth*0.95 });
    });

</script>
</html>